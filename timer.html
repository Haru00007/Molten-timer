<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basketball Timer Display</title>
    <style>
        @font-face {
            font-family: 'DSEG7 Classic';
            src: url('./fonts/DSEG7Classic-Bold.woff2') format('woff2');
            font-weight: bold;
            font-style: normal;
        }

        @font-face {
            font-family: 'LED Calculator';
            src: url('./fonts/LEDCalculator.ttf') format('truetype');
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        .display-container {
            transform: scale(1.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        .row-top {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .arrow {
            font-family: 'LED Calculator', sans-serif;
            font-size: 48px;
            color: #222;
        }

        .arrow.active {
            color: #d00;
        }

        .timer-main {
            font-family: 'DSEG7 Classic', sans-serif;
            font-size: 80px;
            color: #fff;
            letter-spacing: 4px;
            position: relative;
        }

        .timer-placeholder {
            color: rgba(255, 255, 255, 0.08);
        }

        .timer-value {
            position: absolute;
            top: 0;
            right: 0;
        }

        .timer-value.left-align {
            right: auto;
            left: 0;
        }

        .row-middle {
            display: flex;
            align-items: center;
            gap: 12px;
            font-family: 'LED Calculator', sans-serif;
            font-size: 24px;
            color: #0d0;
        }

        .label-hg {
            min-width: 20px;
            text-align: center;
            color: #030;
        }

        .label-hg.active {
            color: #0d0;
        }

        .dot {
            color: #030;
        }

        .dot.active {
            color: #0d0;
        }

        .row-bottom {
            display: flex;
            align-items: baseline;
            gap: 50px;
        }

        .score-container {
            position: relative;
            font-family: 'DSEG7 Classic', sans-serif;
            font-size: 60px;
            text-align: right;
            min-width: 120px;
        }

        .score-placeholder {
            color: rgba(255, 165, 0, 0.1);
        }

        .score-value {
            position: absolute;
            top: 0;
            right: 0;
            color: orange;
        }

        .shot-clock-container {
            position: relative;
            font-family: 'DSEG7 Classic', sans-serif;
            font-size: 60px;
            text-align: right;
            min-width: 80px;
        }

        .shot-clock-placeholder {
            color: rgba(221, 0, 0, 0.1);
        }

        .shot-clock-value {
            position: absolute;
            top: 0;
            right: 0;
            color: #d00;
        }
    </style>
</head>

<body>
    <div class="display-container">
        <div class="row-top">
            <span id="arrow-left" class="arrow">&lt;</span>
            <div class="timer-main">
                <span class="timer-placeholder">88:88</span>
                <span id="timer-display" class="timer-value">10:00</span>
            </div>
            <span id="arrow-right" class="arrow">&gt;</span>
        </div>

        <div class="row-middle">
            <span id="label-left" class="label-hg">H</span>
            <span id="dot-1" class="dot">.</span>
            <span id="dot-2" class="dot">.</span>
            <span id="dot-3" class="dot">.</span>
            <span id="dot-4" class="dot">.</span>
            <span id="dot-5" class="dot">.</span>
            <span id="dot-6" class="dot">.</span>
            <span id="label-right" class="label-hg">G</span>
        </div>

        <div class="row-bottom">
            <div class="score-container">
                <span class="score-placeholder">888</span>
                <span id="score-home" class="score-value">0</span>
            </div>
            <div class="shot-clock-container">
                <span class="shot-clock-placeholder">88</span>
                <span id="shot-clock" class="shot-clock-value">24</span>
            </div>
            <div class="score-container">
                <span class="score-placeholder">888</span>
                <span id="score-guest" class="score-value">0</span>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Firebase設定
        const firebaseConfig = {
            databaseURL: "https://molten-timer-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const stateRef = database.ref('timer-state');

        let state = {
            timerMinutes: 10,
            timerSeconds: 0,
            timerTenths: 0,
            timerRunning: false,
            showTenths: false,
            shotClock: 24,
            shotClockTenths: 0,
            shotClockBlank: false,
            shotClockRunning: false,
            scoreHome: 0,
            scoreGuest: 0,
            scoreHomeBlank: false,
            scoreGuestBlank: false,
            period: null,
            arrowLeft: false,
            arrowRight: false,
            courtFlipped: false,
            hgState: 0,
            programMode: false,
            programNumber: 1
        };

        const timerDisplayEl = document.getElementById('timer-display');
        const arrowLeftEl = document.getElementById('arrow-left');
        const arrowRightEl = document.getElementById('arrow-right');
        const scoreHomeEl = document.getElementById('score-home');
        const scoreGuestEl = document.getElementById('score-guest');
        const shotClockEl = document.getElementById('shot-clock');
        const labelLeftEl = document.getElementById('label-left');
        const labelRightEl = document.getElementById('label-right');
        const dots = [
            document.getElementById('dot-1'),
            document.getElementById('dot-2'),
            document.getElementById('dot-3'),
            document.getElementById('dot-4'),
            document.getElementById('dot-5'),
            document.getElementById('dot-6')
        ];

        // Firebase リアルタイム同期（BroadcastChannelの代わり）
        stateRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                state = { ...state, ...data };
                updateDisplay();
            }
        });

        // BroadcastChannel も維持（同一デバイス内での同期用）
        const channel = new BroadcastChannel('basketball-timer');
        channel.onmessage = (event) => {
            state = { ...state, ...event.data };
            updateDisplay();
        };

        function updateDisplay() {
            const mins = state.timerMinutes;
            const secs = state.timerSeconds;

            const isTenthsMode = state.showTenths && mins === 0 && secs < 60;
            timerDisplayEl.classList.toggle('left-align', isTenthsMode);

            if (isTenthsMode) {
                const secsStr = secs < 10 ? `!${secs}` : `${secs}`;
                timerDisplayEl.textContent = `${secsStr}. ${state.timerTenths}`;
            } else {
                const mStr = mins < 10 ? ` ${mins}` : `${mins}`;
                const sStr = secs < 10 ? `0${secs}` : `${secs}`;
                timerDisplayEl.textContent = `${mStr}:${sStr}`;
            }

            arrowLeftEl.classList.toggle('active', state.arrowLeft);
            arrowRightEl.classList.toggle('active', state.arrowRight);

            let leftLabel = 'H';
            let rightLabel = 'G';
            let leftActive = true;
            let rightActive = true;

            if (state.hgState === 2) {
                leftActive = false;
                rightActive = false;
            } else if (state.hgState === 1) {
                leftLabel = 'G';
                rightLabel = 'H';
            }
            if (state.courtFlipped && state.hgState !== 2) {
                [leftLabel, rightLabel] = [rightLabel, leftLabel];
            }

            labelLeftEl.textContent = leftLabel;
            labelRightEl.textContent = rightLabel;
            labelLeftEl.classList.toggle('active', leftActive);
            labelRightEl.classList.toggle('active', rightActive);

            const periodMap = { 1: 1, 2: 2, 3: 3, 4: 4, 5: 5, 'E': 6 };
            const activeDots = periodMap[state.period] || 0;
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index < activeDots);
            });

            if (state.programMode) {
                scoreHomeEl.textContent = '';
                scoreGuestEl.textContent = `P${String(state.programNumber).padStart(2, '0')}`;
            } else {
                const homeScore = state.courtFlipped ? state.scoreGuest : state.scoreHome;
                const guestScore = state.courtFlipped ? state.scoreHome : state.scoreGuest;
                const homeBlank = state.courtFlipped ? state.scoreGuestBlank : state.scoreHomeBlank;
                const guestBlank = state.courtFlipped ? state.scoreHomeBlank : state.scoreGuestBlank;

                scoreHomeEl.textContent = homeBlank ? '' : homeScore;
                scoreGuestEl.textContent = guestBlank ? '' : guestScore;
            }

            if (state.shotClockBlank) {
                shotClockEl.textContent = '';
            } else if (state.shotClock < 10) {
                shotClockEl.textContent = `${state.shotClock}.${state.shotClockTenths}`;
            } else {
                shotClockEl.textContent = state.shotClock;
            }
        }

        updateDisplay();
    </script>
</body>

</html>